{% extends 'base.html' %}
{% load static %}

{% block content %}
    {% if user.is_authenticated %}
        <a href="/upload">Upload a video</a>
        / <a href="{% url 'logout' %}">Log out</a>
    {% else %}
        <a href="{% url 'login' %}">Log in</a>
    {% endif %}
    <hr>
    <div id="grid">
        {% for video in object_list %}
            <div class="video" data-id="{{ video.id }}">
                <div class="thumbnail">
                    <input type="checkbox" onclick="checkboxClicked({{ page_obj.paginator.object_list|length }})"/>
                    {% if video.thumbnail %}
                        <img src="{{ video.thumbnail.url }}" alt="{{ video.title }}">
                    {% else %}
                        <!-- Hiển thị ảnh mặc định khi không có thumbnail -->
                        <div class="no-thumbnail">No Preview</div>
                    {% endif %}
                </div>
                <b title="{{ video.video }}">{{ video.title }}</b><br>
                {{ video.user.username }}<br>
                {{ video.uploaded_at }}
            </div>
        {% empty %}
            <div>
                {% if user.is_authenticated %}
                    <p>No videos - why not <a href="/upload">upload</a> one?</p>
                {% else %}
                    <p>No videos - <a href="{% url 'login' %}">log in</a> and upload one!</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <hr>
    <div class="actions">
        <button id="select-all">Select All</button>
        <button id="unselect-all">Unselect All</button>
        <button id="delete-selected">Delete</button>
        <button id="index-button" onclick="indexVideos()">Index</button>
    </div>
    <div class="pagination">
        <span class="step-links">
            {% if page_obj.has_previous %}
                <a href="?page=1">&laquo; first</a>
                <a href="?page={{ page_obj.previous_page_number }}">previous</a>
            {% endif %}

            <span class="current">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
            {% endif %}
        </span>
    </div>

    <script>
        function indexVideos() {
            const selectedVideos = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.closest('.video').dataset.id);
            
            if (selectedVideos.length === 0) {
                alert('Please select videos to index');
                return;
            }

            fetch('/api/videos/index', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    videos: selectedVideos,
                    selectedAll: false
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('Indexing started');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting index');
            });
        }

        // Add click handler to Index button
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('#index-button').addEventListener('click', indexVideos);
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Select All button
            document.getElementById('select-all').addEventListener('click', function() {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            });

            // Unselect All button
            document.getElementById('unselect-all').addEventListener('click', function() {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });

            // Delete button
            document.getElementById('delete-selected').addEventListener('click', function() {
                const selectedVideos = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.closest('.video').dataset.id);
                if (selectedVideos.length > 0) {
                    if (confirm('Are you sure you want to delete selected videos?')) {
                        deleteSelectedVideos();
                    }
                }
            });

            // Index button
            document.getElementById('index-button').addEventListener('click', function() {
                const selectedVideos = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.closest('.video').dataset.id);
                if (selectedVideos.length > 0) {
                    indexVideos();
                }
            });
        });
    </script>
{% endblock %}
